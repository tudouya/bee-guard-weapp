<view class="detection">
  <view class="detection-summary">
    <view class="detection-summary-head">
      <text class="detection-summary-title">检测号概览</text>
      <view class="detection-summary-refresh" bindtap="handleRetry">刷新</view>
    </view>
    <view class="detection-summary-metrics">
      <view class="detection-summary-item">
        <text class="detection-summary-label">总数</text>
        <text class="detection-summary-value">{{loading ? '--' : summary.total}}</text>
      </view>
      <view class="detection-summary-item">
        <text class="detection-summary-label">可使用</text>
        <text class="detection-summary-value detection-summary-value--highlight">{{loading ? '--' : summary.assigned}}</text>
      </view>
      <view class="detection-summary-item">
        <text class="detection-summary-label">已使用</text>
        <text class="detection-summary-value">{{loading ? '--' : summary.used}}</text>
      </view>
      <view class="detection-summary-item">
        <text class="detection-summary-label">已过期</text>
        <text class="detection-summary-value">{{loading ? '--' : summary.expired}}</text>
      </view>
    </view>
    <view class="detection-summary-tip" wx:if="{{lastSyncText}}">{{lastSyncText}}</view>
  </view>

  <view class="detection-tabs">
    <view class="detection-tab {{activeTab === item.value ? 'detection-tab--active' : ''}}" wx:for="{{tabs}}" wx:key="value" data-status="{{item.value}}" bindtap="handleTabChange">
      <text>{{item.label}}</text>
      <view class="detection-tab-count" wx:if="{{item.count > 0}}">{{item.count}}</view>
    </view>
  </view>

  <view class="detection-body">
    <view class="detection-loading" wx:if="{{loading}}">加载中...</view>

    <view class="detection-error" wx:elif="{{error}}">
      <text class="detection-error-text">检测号加载失败，请稍后重试</text>
      <view class="u-btn u-btn-primary u-btn--sm" bindtap="handleRetry">重新加载</view>
    </view>

    <view class="detection-empty" wx:elif="{{isEmpty}}">
      <image class="detection-empty-icon" src="/images/profile-icon-detection.png"></image>
      <text class="detection-empty-title">暂无检测号</text>
      <text class="detection-empty-desc">联系管理员或进入检测流程领取新的检测号</text>
      <view class="u-btn u-btn-primary u-btn--sm" bindtap="goAcquireNumber">前往检测页</view>
    </view>

    <view class="detection-list" wx:else>
      <view class="detection-card" wx:for="{{list}}" wx:key="id">
        <view class="detection-card-head">
          <text class="detection-card-code">{{item.full_code}}</text>
          <view class="detection-card-status detection-card-status-{{item.normalizedStatus}}">{{item.statusText}}</view>
        </view>

        <view class="detection-card-meta">
          <text class="detection-card-meta-row">来源：{{item.sourceText || '—'}}</text>
          <text class="detection-card-meta-row">分配时间：{{item.assignedAtText}}</text>
          <text class="detection-card-meta-row" wx:if="{{item.normalizedStatus === 'used'}}">使用时间：{{item.usedAtText}}</text>
          <text class="detection-card-meta-row" wx:if="{{item.normalizedStatus === 'expired'}}">状态：已过期</text>
          <text class="detection-card-meta-row" wx:if="{{item.remark}}">备注：{{item.remark}}</text>
        </view>

        <view class="detection-card-actions">
          <view class="u-btn u-btn--md detection-card-btn" bindtap="copyNumber" data-number="{{item.full_code}}" data-status="{{item.normalizedStatus}}">复制检测号</view>
          <view class="detection-card-secondary" wx:if="{{item.normalizedStatus === 'assigned'}}">
            <view class="u-btn u-btn-primary u-btn--md detection-card-btn" bindtap="startDetection" data-number="{{item.full_code}}">立即检测</view>
          </view>
          <view class="detection-card-secondary" wx:elif="{{item.normalizedStatus === 'used'}}">
            <view class="u-btn u-btn-primary u-btn--md detection-card-btn" bindtap="viewReport" data-number="{{item.full_code}}">查看报告</view>
          </view>
          <view class="detection-card-secondary" wx:else>
            <view class="u-btn u-btn--md detection-card-btn detection-card-btn--muted">已过期</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
